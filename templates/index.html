<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Founder Connect</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">

  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 shadow-lg">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">ðŸš€ Founder Connect</h1>
      <div class="flex items-center gap-4">
        <span class="text-sm bg-white/20 px-3 py-1 rounded-full">
          <span id="active-users">0</span> online
        </span>
        <button onclick="openProfileModal()" 
          class="text-sm bg-white text-blue-600 px-3 py-1 rounded-full hover:bg-gray-200 transition">
          Edit Profile
        </button>
        <span class="text-sm bg-white/20 px-3 py-1 rounded-full" id="user-badge">Guest</span>
      </div>
    </div>
  </header>

  <!-- Main Container -->
  <div class="flex flex-col lg:flex-row h-[calc(100vh-72px)] max-w-7xl mx-auto">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-full lg:w-80 bg-white border-r border-gray-200 overflow-y-auto">
      <div class="p-4 border-b border-gray-200 sticky top-0 bg-white">
        <h2 class="text-xl font-bold mb-3">ðŸ“‹ Threads</h2>
        <button onclick="openNewThreadModal()" 
          class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
          âž• New Thread
        </button>
      </div>
      <div id="thread-list" class="p-4 space-y-3"></div>
    </aside>

    <!-- Chat + Thread Sections -->
    <main class="flex-1 flex flex-col overflow-hidden">
      <!-- Tabs -->
      <div class="bg-white border-b border-gray-200 flex">
        <button onclick="showTab('chat')" id="tab-chat" 
          class="flex-1 px-4 py-3 font-medium border-b-2 border-blue-600 text-blue-600">
          ðŸ’¬ Global Chat
        </button>
        <button onclick="showTab('thread')" id="tab-thread" 
          class="flex-1 px-4 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
          ðŸ“„ Thread View
        </button>
      </div>

      <!-- Chat -->
      <div id="chat-section" class="flex-1 flex flex-col overflow-hidden">
        <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50"></div>
        <div class="bg-white border-t border-gray-200 p-4">
          <div class="flex gap-2">
            <input id="chat-input" type="text" placeholder="Type your message..."
              class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeypress="if(event.key==='Enter') sendChatMessage()">
            <button onclick="sendChatMessage()" 
              class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition w-full sm:w-auto">
              Send
            </button>
          </div>
        </div>
      </div>

      <!-- Thread -->
      <div id="thread-section" class="flex-1 flex-col overflow-hidden hidden">
        <div class="flex-1 overflow-y-auto p-6 bg-white">
          <div id="thread-detail" class="text-center text-gray-500 mt-20">
            <p class="text-xl">ðŸ‘ˆ Select a thread to view</p>
          </div>
        </div>
        <div id="reply-section" class="bg-white border-t border-gray-200 p-4 hidden">
          <div class="flex gap-2">
            <input id="reply-input" type="text" placeholder="Type your reply..." 
              class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeypress="if(event.key==='Enter') sendReply()">
            <button onclick="sendReply()" 
              class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition w-full sm:w-auto">
              Reply
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Profile Modal -->
  <div id="profile-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
      <h3 class="text-2xl font-bold mb-4">Edit Profile</h3>
      <input id="profile-name" type="text" placeholder="Your name" 
        class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <div class="flex gap-2">
        <button onclick="saveProfile()" 
          class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Save</button>
        <button onclick="closeProfileModal()" 
          class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Cancel</button>
      </div>
    </div>
  </div>

  <!-- New Thread Modal -->
  <div id="thread-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
      <h3 class="text-2xl font-bold mb-4">Create New Thread</h3>
      <input id="thread-title" type="text" placeholder="Thread Title" 
        class="w-full p-3 border border-gray-300 rounded-lg mb-3">
      <select id="thread-category" class="w-full p-3 border border-gray-300 rounded-lg mb-3">
        <option value="">Select Category</option>
        <option value="funding">ðŸ’° Funding</option>
        <option value="lesson">ðŸ“š Lessons</option>
        <option value="challenge">âš¡ Challenges</option>
        <option value="opportunity">ðŸŽ¯ Opportunities</option>
      </select>
      <textarea id="thread-content" placeholder="Share your story..." 
        class="w-full p-3 border border-gray-300 rounded-lg mb-4 h-32"></textarea>
      <div class="flex gap-2">
        <button onclick="createThread()" 
          class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Create</button>
        <button onclick="closeThreadModal()" 
          class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let ws = null;
    let userId = 'user_' + Math.random().toString(36).substr(2, 9);
    let displayName = localStorage.getItem('displayName') || "Guest_" + userId.substr(5,4);
    let currentThreadId = null;

    document.getElementById('user-badge').textContent = displayName;

    function openProfileModal(){document.getElementById('profile-modal').classList.remove('hidden');document.getElementById('profile-name').value=displayName;}
    function closeProfileModal(){document.getElementById('profile-modal').classList.add('hidden');}
    function saveProfile(){const n=document.getElementById('profile-name').value.trim();if(n){displayName=n;localStorage.setItem('displayName',n);document.getElementById('user-badge').textContent=n;}closeProfileModal();}

    function connectWebSocket(){
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws/${userId}`;
      ws = new WebSocket(wsUrl);
      ws.onmessage = e => handleMessage(JSON.parse(e.data));
    }
    connectWebSocket();

    function handleMessage(data){
      if(data.type==="chat_message") addChatMessage(data.message);
      if(data.type==="new_thread") loadThreads();
      if(data.type==="new_reply" && currentThreadId===data.thread_id) addReplyToThread(data.reply);
      if(data.type==="user_joined"||data.type==="user_left") document.getElementById('active-users').textContent=data.active_users;
    }

    function sendChatMessage(){
      const input=document.getElementById('chat-input');const msg=input.value.trim();
      if(msg && ws.readyState===WebSocket.OPEN){
        ws.send(JSON.stringify({type:"chat_message",message:msg,name:displayName}));
        input.value="";
      }
    }

    function addChatMessage(msg){
      const chatBox=document.getElementById('chat-box');const div=document.createElement('div');
      div.className="bg-white p-3 rounded-lg shadow";div.innerHTML=`<b>${msg.name}:</b> ${msg.message}`;
      chatBox.appendChild(div);chatBox.scrollTop=chatBox.scrollHeight;
    }

    async function loadThreads(){
      const res=await fetch("/api/threads");const data=await res.json();const list=document.getElementById("thread-list");list.innerHTML="";
      data.threads.forEach(t=>{
        const d=document.createElement("div");d.className="bg-gray-100 p-3 rounded cursor-pointer hover:bg-gray-200";
        d.onclick=()=>loadThread(t.id);d.innerHTML=`<b>${t.title}</b><p class="text-sm text-gray-600">${t.content}</p>`;
        list.appendChild(d);
      });
    }

    async function loadThread(id){
      currentThreadId=id;const res=await fetch(`/api/threads/${id}`);const t=await res.json();
      document.getElementById("thread-detail").innerHTML=`<h2 class="text-2xl font-bold">${t.title}</h2><p class="mb-4">${t.content}</p><div id="replies-list"></div>`;
      document.getElementById("reply-section").classList.remove("hidden");
      t.replies.forEach(addReplyToThread);
      showTab("thread");
    }

    function addReplyToThread(r){
      const list=document.getElementById("replies-list");const d=document.createElement("div");
      d.className="bg-gray-50 p-2 rounded mb-2";d.innerHTML=`<b>${r.name}:</b> ${r.content}`;
      list.appendChild(d);
    }

    async function sendReply(){
      const input=document.getElementById("reply-input");const c=input.value.trim();
      if(c&&currentThreadId){await fetch(`/api/threads/${currentThreadId}/reply`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:c,name:displayName})});input.value="";}
    }

    function openNewThreadModal(){document.getElementById("thread-modal").classList.remove("hidden");}
    function closeThreadModal(){document.getElementById("thread-modal").classList.add("hidden");}

    async function createThread(){
      const title=document.getElementById("thread-title").value.trim();
      const cat=document.getElementById("thread-category").value;
      const content=document.getElementById("thread-content").value.trim();
      if(!title||!cat||!content){alert("Fill all fields");return;}
      await fetch("/api/threads",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title,category:cat,content})});
      closeThreadModal();loadThreads();
    }

    function showTab(tab){
      document.getElementById("chat-section").classList.add("hidden");
      document.getElementById("thread-section").classList.add("hidden");
      if(tab==="chat")document.getElementById("chat-section").classList.remove("hidden");
      else document.getElementById("thread-section").classList.remove("hidden");
    }

    loadThreads();
  </script>
</body>
</html>
